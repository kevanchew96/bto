---
title: "Project Stuff"
author: "Jacob Khoo"
date: "10/11/2020"
output: html_document
---

```{r}
library(rvest)
library(dplyr)
library(httr)
library(jsonlite)
library(tidyr)
library(knitr)
library(stringr)
library(lubridate)
library(XML)
library(htmltab)
library(leaflet.extras)
library(geojsonio)
library(sf)
library(ggmap)
library(googleway)
options(scipen=999)
ggmap::register_google(key = 'AIzaSyBtkpz6CUH-lwaRTLrfnBbGPpaj4pst6Z8')
```

```{r}
urlnov <- "https://www.hdb.gov.sg/cs/infoweb/residential/buying-a-flat/new/sales-launches/bto-sbf-open-booking"
pagenov <- read_html(urlnov)
listingnov <- html_nodes(pagenov,"#UpcomingSalesLaunch-1 a")

dfnov <- urlnov %>% htmltab(which=1)
names(dfnov) <- c("Month.of.Launch","Town/Estate","Flat Mix","Estimated.Flats")
dfnov <- dfnov %>% filter(`Town/Estate`!="Non-Mature Towns/ Estates" & `Town/Estate`!="Mature Towns/ Estates") %>% filter(Month.of.Launch=="November 2020")
dfnov$`Town/Estate` <- gsub("\\s*\\([^\\)]+\\)","",dfnov$`Town/Estate`)
dfnov <- dfnov %>% mutate(`2-room Flexi` = "No")
dfnov <- dfnov %>% mutate(`3-room` = ifelse(grepl("3-room",dfnov$`Flat Mix`),"Yes","No"))
dfnov <- dfnov %>% mutate(`4-room` = ifelse(grepl("4-room",dfnov$`Flat Mix`),"Yes","No"))
dfnov <- dfnov %>% mutate(`5-room` = ifelse(grepl("5-room",dfnov$`Flat Mix`),"Yes","No"))
dfnov <- subset(dfnov, select = -c(`Flat Mix`))
dfnov$Estimated.Flats <- gsub(",","",dfnov$Estimated.Flats)
dfnov$Estimated.Flats <- as.numeric(dfnov$Estimated.Flats)

duptimes <- c(1,1,1,1,2)

idx <- rep(1:nrow(dfnov), duptimes)

dfnov <- dfnov[idx,]

# Have to hard code new BTO locations as they do not have existing address
new_lon <- c(103.823202, 103.730409, 103.853475, 103.936451, 103.879971, 103.875043)
new_lat <- c(1.443867, 1.358622, 1.351645, 1.339557, 1.341481, 1.338430)

dfnov$lon <- new_lon
dfnov$lat <- new_lat

dfnov[5,3] <- 880
dfnov[6,3] <- 350
dfnov$Type <- "BTO"
dfnov
write.csv(dfnov,"BTOInfo.csv",row.names=T)
read.csv("BTOInfo.csv")
```


```{r}
# Estimating Nov BTO Launch Prices using SRX (for 3, 4 and 5 rooms only)
# Prices listed are the max prices
predict_url <- "https://www.srx.com.sg/hdb/bto"
df_predict <- predict_url  %>% htmltab(which=1)
df_predict <- df_predict[c(T,F)]
names(df_predict) <- df_predict[1,]
df_predict <- df_predict[-1, ]
df_predict[,-1] <- lapply(df_predict[,-1], function(x) as.numeric(gsub("[$,]", "", x)))
names(df_predict)[1] <- "Type"
df_predict$Type <- gsub("HDB ", "", df_predict$Type)
df_predict$Type <- gsub(" ", "-", df_predict$Type)
df_predict$Type <- gsub("R", "r", df_predict$Type)
df_predict2 <- data.frame(t(df_predict[-1]))
colnames(df_predict2) <- df_predict[, 1]
df_predict2 <- tibble::rownames_to_column(df_predict2, "Town/Estate") 
df_predict2 <- df_predict2[order(df_predict2$`Town/Estate`),]
df_predict2[6,] <- df_predict2[5,]
dfnov[,5:7] <- df_predict2[,2:4]
write.csv(dfnov,"BTOPredict.csv",row.names = T)
```

```{r}
read.csv("BTOPredict.csv")

```


```{r}
urlaug <- "https://esales.hdb.gov.sg/bp25/launch/20aug/bto/20AUGBTO_page_2756/about0.html"
dfaug <- urlaug %>% htmltab(which=1)

names(dfaug) <- c("Town","Project","Flat.Type","Selling.Price(No.Grants)","Selling.Price(Grants)")
dfaug$Flat.Type <- gsub("[^[:alnum:]]","",dfaug$Flat.Type)
dfaug
```


```{r}
# Primary Schools (source:data.gov.sg)
sch <- read.csv("general-information-of-schools.csv")

# Schools that have mixed levels but with primary school too
mixed_with_primary_schools <- c("CATHOLIC HIGH SCHOOL","CHIJ ST. NICHOLAS GIRLS' SCHOOL","MARIS STELLA HIGH SCHOOL")
mixed_with_primary <- sch %>% filter(school_name %in% mixed_with_primary_schools) %>% select(school_name,address,postal_code)
mixed_with_primary
sch <- rbind(sch %>% filter(mainlevel_code=="PRIMARY") %>% select(school_name,address,postal_code),mixed_with_primary)

sch <- sch %>% unite(address.full,c(address,postal_code), sep= " ")

schools_df <- data.frame(Schools = sch[,1], stringsAsFactors = FALSE)

# Geocode schools by address
schools_ggmap <- geocode(location = sch[,2], output = "latlon", source = "google")
schools_ggmap <- cbind(schools_df, schools_ggmap)

schools_ggmap

# Convert to csv so do not need to geocode everytime
write.csv(schools_ggmap, "Primary Schools.csv", row.names = T)
```

```{r}
# Parks
parks <- file.path(getwd(), 'parks-kml.kml')   
#st_layers(parks)
parks <- read_sf(parks, layer = 'NATIONALPARKS')

parks$Description <- gsub(".*<th>NAME</th> <td>","", parks$Description)
parks$Description <- gsub("<.*", '', parks$Description)
parks
```

```{r}
# Leaflet map

schools <- read.csv("Primary Schools.csv")
btocurrent <- read.csv("BTONov.csv")
html_legend <- "<img src='https://cdn.pixabay.com/photo/2018/02/18/20/34/locomotive-3163448_1280.png'style='width:10px;height:10px;'>MRT<br/>

<img src='https://cdn.pixabay.com/photo/2014/12/22/00/07/tree-576847_1280.png'style='width:10px;height:10px;'>Park<br/>

<img src='https://cdn.pixabay.com/photo/2017/01/31/00/09/book-2022464_1280.png'style='width:10px;height:10px;'>School<br/>

<img src='https://cdn.pixabay.com/photo/2016/08/31/11/54/user-1633249_1280.png'style='width:10px;height:10px;'>School<br/>"



leaflet() %>% addTiles() %>%
addMarkers(data=schools, ~lon, ~lat,popup= ~Schools, label = ~Schools,
                 icon=makeIcon("School.png",iconWidth = 12, iconHeight =12), group="Schools") %>% #image source: https://pixabay.com/vectors/book-books-library-books-reading-2022464/
    addControl(html=html_legend,position = "bottomright")
```   
    
addMarkers(data=parks, popup = ~Description, label = ~Description, icon=makeIcon("Tree.png",iconWidth = 12, iconHeight =12), group="Parks") %>% #image source: https://pixabay.com/vectors/tree-forest-trunk-nature-leaves-576847/
addMarkers(data=df,~lon,~lat, popup= ~`Town.Estate`, label = ~Month.of.Launch, icon=makeIcon("House.png",iconWidth = 12, iconHeight =12), group="BTOcurrent") #%>% # image source: https://pixabay.com/vectors/house-icon-home-symbol-sign-308936/

# MRT image source: https://pixabay.com/vectors/locomotive-railroad-silhouette-3163448/
# CC image source : https://pixabay.com/vectors/user-person-people-profile-account-1633249/
# BTO image source: https://pixabay.com/vectors/house-mortgage-home-silhouette-key-5328786/
# Resale image source: https://pixabay.com/vectors/real-estate-house-silhouette-keys-5420920/
# MOP image source: https://pixabay.com/vectors/home-house-silhouette-icon-146585/
# Parents' house image source: https://pixabay.com/vectors/house-door-f-house-facade-entry-2277025

```{r}
mrturl <- "https://en.wikipedia.org/wiki/List_of_Singapore_MRT_stations"

dfmrt <- mrturl %>% htmltab(which=2, rm_nodata_cols = F)
mrt_df <- data.frame(MRT = dfmrt[,1:3], stringsAsFactors = FALSE)

mrt_df <- mrt_df %>% rename(Code.In.Operation=MRT.Alpha.numeric.code.s.....In.operation, Code.Future=MRT.Alpha.numeric.code.s.....Future, MRT.Station=MRT.Station.name....English.â...Malay)
mrt_df$Code.In.Operation <- gsub("Â","",mrt_df$Code.In.Operation)

mrt_df$Code.Future<- gsub("Â","",mrt_df$Code.Future)
mrt_df

# mrt, bus interchange, shopping malls, CCs
```
```{r}
ggmap::register_google(key = 'AIzaSyBtkpz6CUH-lwaRTLrfnBbGPpaj4pst6Z8')
   not_a_df <- google_geocode(address = "28A Jalan Lempeng Road",key = 'AIzaSyBtkpz6CUH-lwaRTLrfnBbGPpaj4pst6Z8')
   not_a_df
    my_coords <- geocode_coordinates(not_a_df)
    my_coords
    
leaflet(data=my_coords) %>% addTiles %>% addMarkers(~lng,~lat)
```


```{r}


df[1,5]

resale_coords <- geocode(df[,2],output="latlon",source="google")
resale_coords
```

```{r}
df <- cbind(df,resale_coords)
write.csv(df,"Resale_coords.csv",row.names = T)
```

```{r}
df <- read.csv("BTOInfo.csv")
x <- ("BTO")
df
```


```{r}
ccs <- file.path(getwd(), 'community-clubs-kml.kml')   
st_layers(ccs)
ccs <- read_sf(ccs, layer="COMMUNITYCLUBS")

ccs$Description <- gsub(".*<th>NAME</th> <td>","", ccs$Description)
ccs$Description <- gsub("<.*", '', ccs$Description)
ccs
```
```{r}

df <- read.csv("Resale.csv") 
df <- separate(df, "Info", into = c("Room","Model","Year"), sep=" •")
df$Room <- gsub(" R","-R",df$Room)
df$Type <- "Resale"
df$Address <- paste0(df$Address, " Singapore")
resale_coords <- geocode(location=df$Address,output="latlona",source="google")
df <- cbind(df,resale_coords)
write.csv(df,"Resale_coords.csv",row.names = T)

read.csv("Resale_coords.csv")
```
```{r}
df <- read.csv("mrt_df.csv")
mrt_coords<- geocode(location=df$final,output="latlona",source="google")
df <- cbind(df,mrt_coords)
write.csv(df,"mrt_df.csv",row.names = T)

read.csv("mrt_df.csv")
```
```{r}
mrt <- read.csv("mrt_df.csv")
mrt$final <- gsub(" Singapore","",mrt$final)
mrt$final <- ifelse(grepl("N/A",mrt$MRT.Alpha.numeric.code.s.....In.operation,fixed = T),paste0(mrt$final," (U/C)"),mrt$final)
mrt
                    
```
```{r}
bto <- read.csv("BTOPredict.csv")
bto[6,1] <- 6
bto[,5] <- NA
bto$X <- paste0("B",row_number(bto$X))
bto <- bto %>% rename(ID=X,`Month of Launch`=`Month.of.Launch`,`Town/Estate`=`Town.Estate`,
                      `Estimated Flats`=`Estimated.Flats`,`2-Room Flexi`=`X2.room.Flexi`,`3-Room`=`X3.room`,
                      `4-Room`=`X4.room`,`5-Room`=`X5.room`) 
bto
```

```{r}

mop <- read.csv("MOP.csv")
mop$X <- paste0("M",mop$X)
mop <- mop %>% rename(ID=X,`Town/Name`=`Town.Name`,`Project Name`=`BTO.Project.Name`,
                      `Launch Date`=`Launch.Date`,`Year Completed`=`Year.of.Completion`,
                      `Studio Units`=`No.of.Studio.units`,`2-Room Units`=`No.of.2.room.units`,
                      `3-Room Units`=`No.of.3.room.units`,`4-Room Units`=`No.of.4.room.units`,
                      `5-Room Units`=`No.of.5.room.units`, `3Gen Units`=`No.of.3.gen.units`,`Total Units`=`Total.no.of.units`, 
                      `End of MOP`=`End_of_mop`) %>% subset(select=-c(idMOP))

mop <- mop[,c(1,2,3,4,14,5,6,7,8,9,10,11,12,13,15,16)] %>% select(-Type,Type)
mop
```

```{r}
x <- data.frame(x=integer(0))
x[1,1] <- 5
nrow(x %>% filter(x>6))==0
```